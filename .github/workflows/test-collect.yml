---
name: 'Test collect'

on: [workflow_dispatch]
  # ∫push:
  # ∫  branches:
  # ∫  - gh-auth-ldap-geoip-temp

permissions: # least privileges, see https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
  contents: read

jobs:
  build-auth:
    name: build auth
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  build-recursor:
    name: build recursor
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  build-dnsdist:
    name: build dnsdist
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-auth-api:
    needs: build-auth
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-auth-backend:
    needs: build-auth
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-ixfrdist:
    needs: build-auth
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-recursor-api:
    needs: build-recursor
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-recursor-regression:
    needs: build-recursor
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-recursor-bulk:
    name: 'test rec *mini* bulk'
    needs: build-recursor
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  test-dnsdist-regression:
    needs: build-dnsdist
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  swagger-syntax-check:
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  swagger-syntax-check-2:
    runs-on: ubuntu-20.04
    steps:
      - run: echo HI

  collect:
    needs:
      - build-auth
      - build-dnsdist
      - build-recursor
      - swagger-syntax-check
      - swagger-syntax-check-2
      - test-auth-api
      - test-auth-backend
      - test-dnsdist-regression
      - test-ixfrdist
      - test-recursor-api
      - test-recursor-regression
      - test-recursor-bulk
    if: success() || failure()
    runs-on: ubuntu-20.04
    steps:
      - name: Install jq and yq
        run: "sudo snap install jq yq"
      - name: Fail job if any of the previous jobs failed
        run: "for i in `echo '${{ toJSON(needs) }}' | jq '.[].result' | tr -d '\"'`; do if [[ $i == 'failure' ]]; then echo '${{ toJSON(needs) }}'; exit 1; fi; done;"
      - uses: actions/checkout@v3.1.0
        with:
          fetch-depth: 5
          submodules: recursive
      - name: Get list of jobs in the workflow
        run: "yq e '.jobs | keys' .github/workflows/test-collect.yml | awk '{print $2}' | grep -v collect | sort | tee /tmp/workflow-jobs-list.yml; cat /tmp/workflow-jobs-list.yml"
      - name: Fail if there is a job missing on the needs list
        run: "echo '${{ toJSON(needs) }}' | jq 'keys | .[]' | tr -d '\"' | sort | tee /tmp/workflow-needs-list.yml; cat /tmp/workflow-needs-list.yml"
      - name: Fail if there is a job missing on the needs list
        run: "if ! diff -q /tmp/workflow-jobs-list.yml /tmp/workflow-needs-list.yml; then exit 1; fi"

# FIXME: if we can make upload/download-artifact fasts, running unit tests outside of build can let regression tests start earlier
